<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRUDZASO - Admin Dashboard</title>
    <link rel="stylesheet" href="admin-style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>

    <aside class="sidebar">
        <div class="logo-container">
            <div class="logo-red-box">
                <svg viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M10 2h4l1 4h-6l1-4z"></path>
                    <path d="M10 6l-1 9 3 7 3-7-1-9h-4z"></path>
                    <line x1="11" y1="10" x2="13" y2="10"></line>
                    <line x1="10.5" y1="14" x2="13.5" y2="14"></line>
                </svg>
            </div>
            <span style="font-size: 20px; font-weight: bold;">CRUDZASO</span>
        </div>
        <nav style="margin-top: 16px;">
            <a href="#" class="nav-link active"><i class="fa-solid fa-border-all"></i> Dashboard</a>
            <a href="#" class="nav-link"><i class="fa-solid fa-list-check"></i> My Tasks</a>
            <a href="#" class="nav-link"><i class="fa-solid fa-user"></i> Profile</a>
        </nav>
    </aside>

    <main style="flex: 1; display: flex; flex-direction: column;">
        <header>
            <div style="font-size: 11px; color: #94a3b8; font-weight: 600;">
                <i class="fa-solid fa-house"></i> <span style="margin-left: 8px;">/ Dashboard</span>
            </div>
            <div style="display: flex; align-items: center; gap: 16px;">
                <i class="fa-solid fa-bell" style="color: #cbd5e1; cursor: pointer;"></i>
                <div style="display: flex; align-items: center; gap: 12px; border-left: 1px solid #e2e8f0; padding-left: 16px;">
                    <div style="text-align: right;">
                        <p id="admin-name" style="font-size: 12px; font-weight: 800; color: #334155;">Admin User</p>
                        <p style="font-size: 9px; color: #94a3b8; font-weight: bold;">SYSTEM ADMIN</p>
                    </div>
                    <img src="https://ui-avatars.com/api/?name=Admin&background=cbd5e1&color=475569" style="width: 32px; height: 32px; border-radius: 50%;">
                    <button onclick="logout()" class="btn-logout-red"><i class="fa-solid fa-right-from-bracket"></i></button>
                </div>
            </div>
        </header>

        <section style="padding: 24px 32px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px;">
                <div>
                    <h2 style="font-size: 28px; font-weight: 900; color: #1e293b;">Task Manager</h2>
                    <p style="color: #94a3b8; font-size: 14px;">Overview of your current academic performance tasks.</p>
                </div>
                <button onclick="toggleModal(true)" style="background: #2563eb; color: white; border: none; padding: 12px 24px; border-radius: 12px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);">
                    + New Task
                </button>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-header">Total Tasks <i class="fa-solid fa-layer-group" style="color:#3b82f6;"></i></div>
                    <p class="stat-number" id="stat-total">0</p>
                    <p class="label-green">↑ +12% from last week</p>
                </div>
                <div class="stat-card">
                    <div class="stat-header">Completed <i class="fa-solid fa-circle-check" style="color:#22c55e;"></i></div>
                    <p class="stat-number" id="stat-completed">0</p>
                    <p class="label-green">✓ On track</p>
                </div>
                <div class="stat-card">
                    <div class="stat-header">Pending <i class="fa-solid fa-clock" style="color:#f97316;"></i></div>
                    <p class="stat-number" id="stat-pending">0</p>
                    <p class="label-orange">2 High Priority</p>
                </div>
                <div class="stat-card">
                    <div class="stat-header">Overall Progress <i class="fa-solid fa-chart-line" style="color:#a855f7;"></i></div>
                    <p class="stat-number" id="stat-progress">75%</p>
                    <p class="label-green">Keep it up!</p>
                </div>
            </div>

            <div class="table-section">
                <div class="search-container">
                    <div class="search-input-wrapper">
                        <i class="fa-solid fa-magnifying-glass"></i>
                        <input type="text" placeholder="Search tasks...." class="search-input">
                    </div>
                    <div class="filter-bar">
                        <button class="filter-btn">All Tasks</button>
                        <button class="filter-btn">Pending</button>
                        <button class="filter-btn active">Completed</button>
                    </div>
                </div>

                <table>
                    <thead>
                        <tr>
                            <th>Task Name</th>
                            <th>Assignee</th>
                            <th>Status</th>
                            <th>Priority</th>
                            <th>Due Date</th>
                            <th style="text-align:center;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="admin-taskList"></tbody>
                </table>
            </div>
        </section>
    </main>

    <div id="taskModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 style="font-size: 20px; font-weight: 900; margin-bottom: 24px;">New Task Assignment</h3>
            <form id="createTaskForm" style="display: flex; flex-direction: column; gap: 16px;">
                <input type="text" id="modal-taskTitle" placeholder="Task Name" style="padding: 14px; background: #f8fafc; border: none; border-radius: 16px; outline: none;" required>
                <select id="modal-userId" style="padding: 14px; background: #f8fafc; border: none; border-radius: 16px; outline: none;" required></select>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <select id="modal-priority" style="padding: 14px; background: #f8fafc; border: none; border-radius: 16px; outline: none;">
                        <option value="High">High</option>
                        <option value="Medium" selected>Medium</option>
                        <option value="Low">Low</option>
                    </select>
                    <input type="date" id="modal-date" style="padding: 14px; background: #f8fafc; border: none; border-radius: 16px; outline: none;" required>
                </div>
                <div style="display: flex; gap: 16px; margin-top: 16px;">
                    <button type="button" onclick="toggleModal(false)" style="flex: 1; background: transparent; border: none; color: #94a3b8; font-weight: bold; cursor: pointer;">CANCEL</button>
                    <button type="submit" id="submit-btn" style="flex: 1; background: #2563eb; color: white; border: none; padding: 14px; border-radius: 16px; font-weight: bold; cursor: pointer;">ASSIGN</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_TASKS = "http://localhost:3000/tasks";
        const API_USERS = "http://localhost:3000/users";
        let editingTaskId = null;

        // Cargar Dashboard
        async function loadDashboard() {
            try {
                const [tRes, uRes] = await Promise.all([fetch(API_TASKS), fetch(API_USERS)]);
                const tasks = await tRes.json();
                const users = await uRes.json();

                // Stats
                document.getElementById('stat-total').innerText = tasks.length;
                const completedCount = tasks.filter(t => t.status === 'completed').length;
                document.getElementById('stat-completed').innerText = completedCount;
                document.getElementById('stat-pending').innerText = tasks.length - completedCount;

                const container = document.getElementById('admin-taskList');
                
                const priorityColors = { 'High': '#ef4444', 'Medium': '#f59e0b', 'Low': '#10b981' };

                container.innerHTML = tasks.map(t => {
                    const user = users.find(u => String(u.id) === String(t.userId)) || { name: 'Student' };
                    let statusClass = t.status === 'completed' ? "bg-completed" : "bg-in-progress";
                    let statusText = t.status === 'completed' ? "Completed" : "In Progress";
                    const pColor = priorityColors[t.priority] || '#94a3b8';

                    return `
                        <tr>
                            <td style="font-weight: bold; color: #334155;">${t.title}</td>
                            <td style="color: #64748b;">${user.name}</td>
                            <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                            <td>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <div style="width: 10px; height: 10px; border-radius: 50%; background-color: ${pColor}; flex-shrink: 0;"></div>
                                    <span style="color: #1e293b; font-size: 14px; font-weight: 500;">${t.priority}</span>
                                </div>
                            </td>
                            <td style="color: ${t.priority === 'High' ? '#ef4444' : '#64748b'}; font-weight: 500;">${t.date || '---'}</td>
                            <td style="text-align:center;">
                                <div style="display:flex; justify-content:center; gap:12px;">
                                    <i onclick="editTask('${t.id}')" class="fa-solid fa-pen" style="color: #cbd5e1; cursor:pointer;"></i>
                                    <i onclick="deleteTask('${t.id}')" class="fa-solid fa-trash" style="color: #cbd5e1; cursor:pointer;"></i>
                                </div>
                            </td>
                        </tr>`;
                }).join('');
            } catch (err) {
                console.error("Error cargando dashboard:", err);
            }
        }

        // Editar Tarea - FUNCION CORREGIDA
        async function editTask(id) {
            console.log("Intentando editar tarea con ID:", id);
            editingTaskId = id;
            
            try {
                const res = await fetch(`${API_TASKS}/${id}`);
                if (!res.ok) throw new Error("No se pudo obtener la tarea");
                const task = await res.json();

                await loadUserOptions();
                
                document.getElementById('modal-taskTitle').value = task.title;
                document.getElementById('modal-userId').value = task.userId;
                document.getElementById('modal-priority').value = task.priority;
                document.getElementById('modal-date').value = task.date || "";
                
                document.querySelector('#taskModal h3').innerText = "Edit Task";
                document.getElementById('submit-btn').innerText = "SAVE CHANGES";
                
                toggleModal(true);
            } catch (error) {
                console.error("Error al cargar la tarea para editar:", error);
                alert("Error al cargar la tarea");
            }
        }

        function toggleModal(show) {
            const modal = document.getElementById('taskModal');
            if (!show) {
                editingTaskId = null;
                document.getElementById('createTaskForm').reset();
                document.querySelector('#taskModal h3').innerText = "New Task Assignment";
                document.getElementById('submit-btn').innerText = "ASSIGN";
            }
            modal.classList.toggle('hidden', !show);
            if(show && !editingTaskId) loadUserOptions();
        }

        async function loadUserOptions() {
            const res = await fetch(API_USERS);
            const users = await res.json();
            document.getElementById('modal-userId').innerHTML = users
                .filter(u => u.role !== 'admin')
                .map(u => `<option value="${u.id}">${u.name}</option>`)
                .join('');
        }

        document.getElementById('createTaskForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const taskDate = document.getElementById('modal-date').value;

            const data = {
                title: document.getElementById('modal-taskTitle').value,
                userId: document.getElementById('modal-userId').value,
                priority: document.getElementById('modal-priority').value,
                date: taskDate
            };

            const url = editingTaskId ? `${API_TASKS}/${editingTaskId}` : API_TASKS;
            const method = editingTaskId ? 'PATCH' : 'POST';
            if (!editingTaskId) data.status = 'pending';

            await fetch(url, { 
                method: method, 
                headers: {'Content-Type': 'application/json'}, 
                body: JSON.stringify(data) 
            });

            toggleModal(false);
            loadDashboard();
        });

        async function deleteTask(id) {
            if(confirm('Delete task?')) { 
                await fetch(`${API_TASKS}/${id}`, { method: 'DELETE' }); 
                loadDashboard(); 
            }
        }

        function logout() { 
            localStorage.clear(); 
            window.location.href = 'index.html'; 
        }

        loadDashboard();
    </script>
</body>
</html>